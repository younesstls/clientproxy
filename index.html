<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abonnements Dashboard</title>
  <style>
    :root{
      --bg1:#070b1a; --bg2:#0b1a2a;
      --card:rgba(10,18,35,.72);
      --stroke:rgba(255,255,255,.08);
      --text:#e9f0ff; --muted:#a7b3cc;
      --blue:#2f6bff; --blue2:#1b3aa7;
      --green:#24c17a; --red:#ff4d4d; --amber:#ffb020;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(46,83,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(0,255,170,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,0,200,.10), transparent 60%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:24px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{font-size:30px;margin:0;display:flex;align-items:center;gap:10px}
    h1 .icon{font-size:28px}
    .sub{color:var(--muted);margin-top:6px;font-size:13px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      box-shadow:none;
      transition:.2s;
      font-weight:600;
    }
    button.primary{background:linear-gradient(180deg,var(--blue),var(--blue2));border:none}
    button.danger{background:rgba(255,77,77,.12);border:1px solid rgba(255,77,77,.35)}
    button:hover{transform:translateY(-1px);filter:brightness(1.03)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .grid4{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
      margin:14px 0 18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(8px);
    }
    .stat .label{color:var(--muted);font-size:13px}
    .stat .value{font-size:26px;font-weight:800;margin-top:6px}
    .bigcard{padding:18px}
    .sectionTitle{font-size:16px;font-weight:800;margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{
      flex:1;
      min-width:220px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{font-size:12px;color:var(--muted)}
    input,select{
      height:44px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:0 12px;
      outline:none;
    }
    input[type="number"]{max-width:160px}
    .hint{font-size:12px;color:var(--muted);margin-left:auto}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      font-size:12px;color:var(--muted)
    }
    .pill.ok{color:#bff5dd;border-color:rgba(36,193,122,.35);background:rgba(36,193,122,.10)}
    .pill.bad{color:#ffd0d0;border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.10)}
    .warn{color:#ffe6b5}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px}
    th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px}
    td{
      padding:12px 10px;
      background:rgba(255,255,255,.04);
      border-top:1px solid var(--stroke);
      border-bottom:1px solid var(--stroke);
    }
    td:first-child{border-left:1px solid var(--stroke);border-top-left-radius:12px;border-bottom-left-radius:12px}
    td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;font-weight:700;font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .tag.green{background:rgba(36,193,122,.12);border-color:rgba(36,193,122,.35)}
    .tag.red{background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.35)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions button{padding:9px 12px;border-radius:12px}
    .actions .mini{background:rgba(255,255,255,.05)}
    .actions .mini.green{background:rgba(36,193,122,.12);border-color:rgba(36,193,122,.35)}
    .actions .mini.red{background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.35)}
    .footer{color:var(--muted);text-align:center;margin-top:12px;font-size:12px}
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(10,18,35,.85);backdrop-filter:blur(10px);
      box-shadow:var(--shadow);display:none;gap:10px;align-items:center;max-width:92vw;
      z-index:9999;
    }
    .toast.show{display:flex}
    .toast .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--green)}
    .dot.bad{background:var(--red)}
    .dot.warn{background:var(--amber)}
    .toast .msg{font-size:13px;color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1><span class="icon">üìä</span> Abonnements Dashboard</h1>
        <div class="sub">Clients ‚Ä¢ Date fin auto ‚Ä¢ Jours restants ‚Ä¢ Notifications Telegram (via Worker)</div>
      </div>
      <div class="btns">
        <button id="exportBtn" class="primary">Export JSON</button>
        <button id="importBtn">Import JSON</button>
        <button id="resetBtn" class="danger">Reset</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="grid4">
      <div class="card stat">
        <div class="label">Total</div>
        <div class="value" id="sTotal">0</div>
      </div>
      <div class="card stat">
        <div class="label">Actifs</div>
        <div class="value" id="sActive">0</div>
      </div>
      <div class="card stat">
        <div class="label">Expire bient√¥t</div>
        <div class="value" id="sSoon">0</div>
      </div>
      <div class="card stat">
        <div class="label">Expir√©s</div>
        <div class="value" id="sExpired">0</div>
      </div>
    </div>

    <div class="card bigcard">
      <div class="sectionTitle">Cloudflare Worker (API)</div>
      <div class="row">
        <div class="field" style="min-width:420px">
          <label>Worker Base URL</label>
          <input id="workerBase" placeholder="https://xxxx.workers.dev" />
        </div>
        <div class="field" style="max-width:200px">
          <label>Notifier si jours ‚â§</label>
          <input id="thresholdDays" type="number" min="0" step="1" />
        </div>
        <button id="loadCloudBtn">Load (Cloud)</button>
        <button id="saveCloudBtn">Save (Cloud)</button>
        <button id="checkNotifyBtn" class="primary">Check & Notify</button>
        <div class="hint">
          ‚ö†Ô∏è Les secrets Telegram (BOT_TOKEN / CHAT_ID) ŸÉÿßŸäŸÜŸäŸÜ ŸÅ Worker.
        </div>
      </div>
      <div style="margin-top:10px">
        <span class="pill" id="cloudStatus"><span class="dot warn"></span><span>Ready</span></span>
      </div>
    </div>

    <div class="card bigcard">
      <div class="sectionTitle">Ajouter / Modifier un client</div>
      <div class="row">
        <div class="field" style="min-width:340px">
          <label>Client (nom)</label>
          <input id="cName" placeholder="ex: houssa group 200 proxy 1500dh" />
        </div>
        <div class="field" style="max-width:220px">
          <label>D√©but</label>
          <input id="cStart" type="date" />
        </div>
        <div class="field" style="max-width:220px">
          <label>Dur√©e (jours)</label>
          <input id="cDays" type="number" min="1" step="1" value="30" />
        </div>
        <button id="addBtn" class="primary">+ Add Client</button>
      </div>
      <div class="sub" style="margin-top:8px">
        ‚ûú Fin = D√©but + Dur√©e. Actions: Renew, Disable/Enable, Delete.
      </div>
    </div>

    <div class="card bigcard">
      <table>
        <thead>
          <tr>
            <th>Client</th>
            <th>D√©but</th>
            <th>Dur√©e</th>
            <th>Fin</th>
            <th>Jours restants</th>
            <th>Statut</th>
            <th>TelegramSent</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="footer">by.bestfriend ‚Ä¢ KV + Worker ‚Ä¢ GitHub Pages</div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="dot warn" id="toastDot"></div>
    <div class="msg" id="toastMsg"></div>
  </div>

<script>
(() => {
  const LS_KEY = "abonnements_state_v2";
  const $ = (id) => document.getElementById(id);

  const state = {
    data: {
      workerBase: "",
      thresholdDays: 2,
      clients: []
    },
    editId: null
  };

  const todayISO = () => {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };

  const addDays = (iso, days) => {
    const d = new Date(iso + "T00:00:00Z");
    d.setUTCDate(d.getUTCDate() + Number(days || 0));
    return d.toISOString().slice(0,10);
  };

  const daysBetween = (fromISO, toISO) => {
    const a = new Date(fromISO + "T00:00:00Z").getTime();
    const b = new Date(toISO + "T00:00:00Z").getTime();
    return Math.ceil((b - a) / 86400000);
  };

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const toast = (msg, type="warn") => {
    const t = $("toast");
    $("toastMsg").textContent = msg;
    $("toastDot").className = "dot " + (type === "ok" ? "ok" : type === "bad" ? "bad" : "warn");
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2600);
  };

  const setCloudStatus = (text, type="warn") => {
    const pill = $("cloudStatus");
    pill.className = "pill " + (type === "ok" ? "ok" : type === "bad" ? "bad" : "");
    pill.innerHTML = `<span class="dot ${type}"></span><span>${text}</span>`;
  };

  const saveLocal = () => localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  const loadLocal = () => {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try {
      const obj = JSON.parse(raw);
      if (obj && typeof obj === "object") state.data = { ...state.data, ...obj };
    } catch {}
  };

  const api = (path) => {
    const base = (state.data.workerBase || "").replace(/\/+$/,"");
    return base + path;
  };

  async function apiFetch(path, opts = {}) {
    const url = api(path);
    const r = await fetch(url, {
      ...opts,
      headers: { "Content-Type":"application/json", ...(opts.headers || {}) },
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
      throw new Error(msg);
    }
    return data;
  }

  const stats = () => {
    const threshold = Number(state.data.thresholdDays || 0);
    const t = todayISO();
    const list = state.data.clients || [];
    let total = list.length;
    let active = 0, soon = 0, expired = 0;
    for (const c of list) {
      const isActive = c.active !== false;
      if (isActive) active++;
      const d = daysBetween(t, c.end);
      if (d < 0) expired++;
      else if (d <= threshold && isActive) soon++;
    }
    $("sTotal").textContent = total;
    $("sActive").textContent = active;
    $("sSoon").textContent = soon;
    $("sExpired").textContent = expired;
  };

  const render = () => {
    stats();
    const t = todayISO();
    const tbody = $("tbody");
    tbody.innerHTML = "";
    const threshold = Number(state.data.thresholdDays || 0);

    const sorted = [...(state.data.clients || [])].sort((a,b) => a.end.localeCompare(b.end));

    for (const c of sorted) {
      const remain = daysBetween(t, c.end);
      const statusTag = c.active === false
        ? `<span class="tag red">Disabled</span>`
        : `<span class="tag green">Actif</span>`;

      const remainTxt = remain < 0 ? `${remain} j` : `${remain} j`;
      const soonWarn = (remain >= 0 && remain <= threshold && c.active !== false) ? " ‚ö†Ô∏è" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(c.name || "")}</b></td>
        <td>${c.start}</td>
        <td>${c.days} j</td>
        <td>${c.end}</td>
        <td><b>${remainTxt}</b>${soonWarn}</td>
        <td>${statusTag}</td>
        <td>${c.telegramSentAt ? escapeHtml(c.telegramSentAt) : "‚Äî"}</td>
        <td>
          <div class="actions">
            <button class="mini green" data-act="renew" data-id="${c.id}">Renew +30</button>
            <button class="mini" data-act="edit" data-id="${c.id}">Edit</button>
            <button class="mini" data-act="toggle" data-id="${c.id}">${c.active === false ? "Enable" : "Disable"}</button>
            <button class="mini red" data-act="del" data-id="${c.id}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  };

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function resetForm(){
    state.editId = null;
    $("cName").value = "";
    $("cStart").value = todayISO();
    $("cDays").value = 30;
    $("addBtn").textContent = "+ Add Client";
  }

  function upsertClient(){
    const name = $("cName").value.trim();
    const start = $("cStart").value || todayISO();
    const days = Number($("cDays").value || 30);
    if (!name) return toast("Client name required", "bad");
    if (!days || days < 1) return toast("Dur√©e invalid", "bad");

    const end = addDays(start, days);

    if (state.editId) {
      const idx = state.data.clients.findIndex(x => x.id === state.editId);
      if (idx >= 0) {
        state.data.clients[idx] = { ...state.data.clients[idx], name, start, days, end };
      }
      toast("Client updated ‚úÖ", "ok");
    } else {
      state.data.clients.push({ id: uid(), name, start, days, end, active: true });
      toast("Client added ‚úÖ", "ok");
    }

    saveLocal();
    resetForm();
    render();
  }

  async function loadCloud(){
    try {
      setCloudStatus("Loading cloud‚Ä¶", "warn");
      const out = await apiFetch("/api/clients", { method:"GET" });
      const data = out.data || { thresholdDays: 2, clients: [] };
      state.data.thresholdDays = Number(data.thresholdDays ?? 2);
      state.data.clients = Array.isArray(data.clients) ? data.clients : [];
      $("thresholdDays").value = state.data.thresholdDays;
      saveLocal();
      render();
      setCloudStatus("Cloud loaded ‚úÖ", "ok");
      toast("Cloud loaded ‚úÖ", "ok");
    } catch (e) {
      setCloudStatus("Load cloud failed ‚ùå", "bad");
      toast("Load failed: " + (e.message || e), "bad");
    }
  }

  async function saveCloud(){
    try {
      setCloudStatus("Saving cloud‚Ä¶", "warn");
      const body = { thresholdDays: Number(state.data.thresholdDays||2), clients: state.data.clients || [] };
      await apiFetch("/api/clients", { method:"POST", body: JSON.stringify(body) });
      setCloudStatus("Saved ‚úÖ", "ok");
      toast("Saved to cloud ‚úÖ", "ok");
    } catch (e) {
      setCloudStatus("Save cloud failed ‚ùå", "bad");
      toast("Save failed: " + (e.message || e), "bad");
    }
  }

  async function checkAndNotify(){
    try {
      const threshold = Number(state.data.thresholdDays || 2);
      const t = todayISO();
      const expiring = (state.data.clients || [])
        .filter(c => c && c.active !== false)
        .map(c => ({ c, d: daysBetween(t, c.end) }))
        .filter(x => x.d >= 0 && x.d <= threshold);

      if (!expiring.length) {
        toast(`No expiring clients ‚úÖ (‚â§ ${threshold} days)`, "ok");
        return;
      }

      const lines = expiring
        .map(x => `‚Ä¢ ${x.c.name} ‚Üí ÿ®ÿßŸÇŸä ${x.d} ŸäŸàŸÖ (ÿßŸÑŸÜŸáÿßŸäÿ©: ${x.c.end})`)
        .join("\n");

      const text = `‚ö†Ô∏è Expiration ŸÇÿ±Ÿäÿ® (‚â§ ${threshold} ÿ£ŸäÿßŸÖ)\n\n${lines}`;

      const r = await apiFetch("/api/notify", {
        method:"POST",
        body: JSON.stringify({ message: text })
      });

      const sentAt = new Date().toISOString().slice(0,19).replace("T"," ");
      for (const x of expiring) x.c.telegramSentAt = sentAt;

      saveLocal();
      render();
      toast("Telegram sent ‚úÖ", "ok");
      setCloudStatus("Notified ‚úÖ", "ok");
    } catch (e) {
      toast("Check & Notify failed ‚ùå: " + (e.message || e), "bad");
      setCloudStatus("Notify failed ‚ùå", "bad");
    }
  }

  // events
  $("addBtn").addEventListener("click", upsertClient);

  $("tbody").addEventListener("click", (ev) => {
    const btn = ev.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    const idx = state.data.clients.findIndex(x => x.id === id);
    if (idx < 0) return;
    const c = state.data.clients[idx];

    if (act === "renew") {
      c.days = Number(c.days || 30) + 30;
      c.end = addDays(c.start, c.days);
      toast("Renew +30 ‚úÖ", "ok");
      saveLocal(); render();
    }
    if (act === "edit") {
      state.editId = c.id;
      $("cName").value = c.name;
      $("cStart").value = c.start;
      $("cDays").value = c.days;
      $("addBtn").textContent = "Save changes";
      window.scrollTo({ top: 0, behavior:"smooth" });
    }
    if (act === "toggle") {
      c.active = c.active === false ? true : false;
      toast(c.active ? "Enabled ‚úÖ" : "Disabled ‚úÖ", "ok");
      saveLocal(); render();
    }
    if (act === "del") {
      state.data.clients.splice(idx,1);
      toast("Deleted ‚úÖ", "ok");
      saveLocal(); render();
    }
  });

  $("loadCloudBtn").addEventListener("click", loadCloud);
  $("saveCloudBtn").addEventListener("click", saveCloud);
  $("checkNotifyBtn").addEventListener("click", checkAndNotify);

  $("workerBase").addEventListener("change", () => {
    state.data.workerBase = $("workerBase").value.trim();
    saveLocal();
  });

  $("thresholdDays").addEventListener("change", () => {
    state.data.thresholdDays = Number($("thresholdDays").value || 2);
    saveLocal();
    render();
  });

  $("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state.data, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "abonnements_export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", async () => {
    const f = $("importFile").files?.[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if (!obj || typeof obj !== "object") throw new Error("Invalid JSON");
      state.data = { ...state.data, ...obj };
      saveLocal();
      render();
      toast("Imported ‚úÖ", "ok");
    } catch (e) {
      toast("Import failed ‚ùå", "bad");
    } finally {
      $("importFile").value = "";
    }
  });

  $("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset local data?")) return;
    localStorage.removeItem(LS_KEY);
    state.data = { workerBase:"", thresholdDays: 2, clients: [] };
    resetForm();
    render();
    $("workerBase").value = "";
    $("thresholdDays").value = 2;
    setCloudStatus("Ready", "warn");
    toast("Reset ‚úÖ", "ok");
  });

  // init
  loadLocal();
  $("workerBase").value = state.data.workerBase || "https://empty-wood-8ebe.youness-moumine-filali.workers.dev";
  $("thresholdDays").value = Number(state.data.thresholdDays || 2);
  $("cStart").value = todayISO();
  if (!state.data.workerBase) state.data.workerBase = $("workerBase").value.trim();
  // ensure ids
  state.data.clients = (state.data.clients || []).map(c => ({ id: c.id || uid(), ...c }));
  saveLocal();
  resetForm();
  render();
})();
</script>
</body>
</html>

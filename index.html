<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abonnements Dashboard (KV + Worker)</title>
  <style>
    :root{
      --bg:#060a14;
      --card:#0b1328cc;
      --card2:#0b1328b3;
      --stroke:#1b2a55;
      --text:#e8eeff;
      --muted:#93a3c7;
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --btn:#1d4ed8;
      --btn2:#334155;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", sans-serif;
      background:
        radial-gradient(1200px 600px at 25% 20%, rgba(29,78,216,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 75%, rgba(45,212,191,.18), transparent 60%),
        radial-gradient(1000px 700px at 55% 105%, rgba(251,113,133,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:28px 18px 40px;
    }
    .wrap{max-width:1120px;margin:0 auto}
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }
    .title{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(45,212,191,.9), rgba(29,78,216,.95));
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:13px}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button, .btn{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:.15s transform, .15s opacity;
      user-select:none;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px); opacity:.92}
    .primary{
      background: linear-gradient(180deg, rgba(29,78,216,.95), rgba(29,78,216,.75));
      border-color: rgba(29,78,216,.55);
    }
    .danger{
      background: linear-gradient(180deg, rgba(190,18,60,.85), rgba(190,18,60,.55));
      border-color: rgba(190,18,60,.55);
    }
    .ghost{
      background: linear-gradient(180deg, rgba(51,65,85,.65), rgba(51,65,85,.35));
      border-color: rgba(51,65,85,.65);
    }

    .gridStats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:14px;
      margin: 10px 0 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(11,19,40,.82), rgba(11,19,40,.55));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .stat .label{color:var(--muted); font-size:12px; margin-bottom:8px}
    .stat .value{font-size:30px; font-weight:800; letter-spacing:.3px}
    .stat small{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:14px;
      margin-bottom:14px;
    }
    .card h2{
      margin:0 0 14px;
      font-size:16px;
      letter-spacing:.2px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width: 210px;
    }
    .field label{
      color:var(--muted);
      font-size:12px;
    }
    input, select, textarea{
      background: rgba(3,7,18,.65);
      border:1px solid var(--stroke);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    input::placeholder{color:#7283ad}
    input:focus, textarea:focus{
      border-color: rgba(45,212,191,.45);
      box-shadow: 0 0 0 3px rgba(45,212,191,.12);
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top:10px;
    }

    .statusLine{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(3,7,18,.45);
      color:var(--text);
      font-size:12px;
      font-weight:700;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill.ok{border-color: rgba(45,212,191,.4); background: rgba(45,212,191,.10)}
    .pill.bad{border-color: rgba(251,113,133,.4); background: rgba(251,113,133,.10)}
    .pill.warn{border-color: rgba(251,191,36,.4); background: rgba(251,191,36,.10)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: rgba(3,7,18,.35);
    }
    th, td{
      padding:12px 12px;
      border-bottom:1px solid rgba(27,42,85,.55);
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-size:12px;
      background: rgba(11,19,40,.55);
    }
    tr:last-child td{border-bottom:0}
    .nameCell{font-weight:800}
    .tdRight{text-align:right}
    .btnSmall{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:800;
    }
    .btnGroup{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap}
    .footer{
      text-align:center;
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }

    .toastWrap{
      position:fixed;
      left:0; right:0;
      bottom:18px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      padding:0 10px;
      z-index:99;
    }
    .toast{
      pointer-events:none;
      max-width:900px;
      width: fit-content;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(3,7,18,.75);
      box-shadow: var(--shadow);
      color: var(--text);
      font-weight:700;
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      opacity:0;
      transform: translateY(10px);
      transition: .22s ease;
      white-space: pre-wrap;
    }
    .toast.show{opacity:1; transform: translateY(0px)}
    .toast .tDot{width:9px;height:9px;border-radius:50%}
    .toast .tDot.ok{background:var(--ok)}
    .toast .tDot.warn{background:var(--warn)}
    .toast .tDot.bad{background:var(--bad)}

    @media (max-width: 980px){
      .gridStats{grid-template-columns: repeat(2, minmax(0,1fr))}
      .grid2{grid-template-columns: 1fr}
      .actions{justify-content:flex-start}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <div class="logo"></div>
      <div>
        <h1>Abonnements Dashboard</h1>
        <div class="subtitle">Clients ‚Ä¢ Date fin auto ‚Ä¢ Jours restants ‚Ä¢ Notifications Telegram (via Worker)</div>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="btnExport">Export JSON</button>
      <button class="ghost" id="btnImport">Import JSON</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="gridStats">
    <div class="card stat">
      <div class="label">Total</div>
      <div class="value" id="statTotal">0</div>
    </div>
    <div class="card stat">
      <div class="label">Actifs</div>
      <div class="value" id="statActive">0</div>
    </div>
    <div class="card stat">
      <div class="label">Expire bient√¥t</div>
      <div class="value" id="statSoon">0</div>
      <small>(‚â§ seuil)</small>
    </div>
    <div class="card stat">
      <div class="label">Expir√©s</div>
      <div class="value" id="statExpired">0</div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h2>Cloudflare Worker (API)</h2>
      <div class="row">
        <div class="field" style="flex:1.4;min-width:260px;">
          <label>Worker Base URL</label>
          <input id="workerBase" placeholder="https://xxxx.yourname.workers.dev" />
        </div>
        <div class="field" style="max-width:220px;">
          <label>Notifier si jours ‚â§</label>
          <input id="thresholdDays" type="number" min="0" step="1" />
        </div>
        <div class="row" style="gap:8px; margin-top:18px;">
          <button class="ghost btnSmall" id="btnLoadCloud">Load (Cloud)</button>
          <button class="ghost btnSmall" id="btnSaveCloud">Save (Cloud)</button>
          <button class="primary btnSmall" id="btnCheckNotify">Check & Notify</button>
        </div>
      </div>

      <div class="statusLine">
        <span class="dot" id="apiDot"></span>
        <span id="apiStatus">Ready</span>
        <span style="margin-left:auto" class="hint">‚ö†Ô∏è Il faut KV binding <b>CLIENTS_KV</b> + secrets <b>BOT_TOKEN</b> & <b>CHAT_ID</b> dans le Worker.</span>
      </div>
    </div>

    <div class="card">
      <h2>Ajouter / Modifier un client</h2>
      <div class="row">
        <div class="field" style="flex:1.2;min-width:260px;">
          <label>Client (nom)</label>
          <input id="clientName" placeholder="ex: houssa group 200 proxy 1500dh" />
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>D√©but</label>
          <input id="startDate" type="date" />
        </div>
        <div class="field">
          <label>Dur√©e (jours)</label>
          <input id="durationDays" type="number" min="1" step="1" value="30" />
        </div>
        <div class="row" style="gap:8px; margin-top:22px;">
          <button class="primary" id="btnAddUpdate">+ Add Client</button>
          <button class="ghost" id="btnCancelEdit" style="display:none;">Cancel</button>
        </div>
      </div>
      <div class="hint">üìå Fin = D√©but + Dur√©e. Tu peux g√©rer local (LocalStorage) ou cloud (KV via Worker).</div>
    </div>
  </div>

  <div class="card">
    <h2>Clients</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="min-width:220px;">Client</th>
            <th>D√©but</th>
            <th>Dur√©e</th>
            <th>Fin</th>
            <th>Jours restants</th>
            <th>Statut</th>
            <th>TelegramSent</th>
            <th class="tdRight">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footer">by.bestfriend ‚Ä¢ KV + Worker ‚Ä¢ GitHub Pages</div>
  </div>
</div>

<div class="toastWrap">
  <div class="toast" id="toast">
    <span class="tDot ok" id="toastDot"></span>
    <span id="toastText"></span>
  </div>
</div>

<input id="importFile" type="file" accept="application/json" style="display:none" />

<script>
  // =========================
  //  Abonnements Dashboard
  //  - LocalStorage (device)
  //  - Cloud (KV via Worker API)
  //
  //  IMPORTANT:
  //  - Local is per device/browser.
  //  - Cloud is shared (PC + phone) after Save(Cloud) and Load(Cloud).
  // =========================

  const LS_KEY = "abonnements_dashboard_v2";

  const $ = (id) => document.getElementById(id);

  const state = {
    editingId: null,
    data: {
      workerBase: "",
      thresholdDays: 2,
      clients: []
    }
  };

  // ---------- Utils ----------
  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }
  function isoDate(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const day = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDays(dateStr, days){
    const d = new Date(dateStr + "T00:00:00");
    d.setDate(d.getDate() + Number(days || 0));
    return isoDate(d);
  }
  function diffDaysFromToday(endStr){
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // local midnight
    const end = new Date(endStr + "T00:00:00");
    const ms = end - today;
    return Math.ceil(ms / 86400000);
  }
  function safeNum(n, fallback){
    const x = Number(n);
    return Number.isFinite(x) ? x : fallback;
  }

  // ---------- Toast ----------
  let toastTimer = null;
  function toast(msg, kind="ok"){
    $("toastText").textContent = msg;
    const dot = $("toastDot");
    dot.className = "tDot " + (kind === "bad" ? "bad" : (kind === "warn" ? "warn" : "ok"));
    const t = $("toast");
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>t.classList.remove("show"), 2200);
  }

  // ---------- Storage ----------
  function loadLocal(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        // merge
        state.data.workerBase = obj.workerBase || state.data.workerBase;
        state.data.thresholdDays = safeNum(obj.thresholdDays, 2);
        state.data.clients = Array.isArray(obj.clients) ? obj.clients : [];
      }
    }catch(e){
      console.warn(e);
    }
  }
  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  }

  // ---------- API ----------
  function normBase(base){
    base = (base || "").trim();
    if(!base) return "";
    // remove trailing slash
    return base.replace(/\/+$/,"");
  }

  async function apiFetch(path, options={}){
    const base = normBase(state.data.workerBase || $("workerBase").value);
    if(!base) throw new Error("Worker Base URL missing");
    const url = base + path;
    const res = await fetch(url, {
      method: options.method || "GET",
      headers: Object.assign({"Content-Type":"application/json"}, options.headers||{}),
      body: options.body ? JSON.stringify(options.body) : undefined
    });
    const text = await res.text();
    let json;
    try{ json = text ? JSON.parse(text) : {}; } catch { json = { raw:text }; }
    if(!res.ok){
      const err = (json && (json.error || json.message)) ? (json.error || json.message) : ("HTTP " + res.status);
      throw new Error(err);
    }
    return json;
  }

  async function pingWorker(){
    try{
      const out = await apiFetch("/api/check", {method:"GET"});
      setApiStatus(true, out && out.ok ? "Worker OK ‚úÖ" : "Worker up");
      return true;
    }catch(e){
      setApiStatus(false, "Check failed ‚ùå " + e.message);
      return false;
    }
  }

  function setApiStatus(ok, msg){
    $("apiStatus").textContent = msg;
    const dot = $("apiDot");
    dot.className = "dot " + (ok ? "ok" : "bad");
  }

  // ---------- Render / Stats ----------
  function computeClientRow(c){
    const start = c.start || isoDate(new Date());
    const duration = safeNum(c.duration, 30);
    const end = c.end || addDays(start, duration);
    const daysLeft = diffDaysFromToday(end);
    const active = c.active !== false;
    const expired = daysLeft < 0;
    const soon = !expired && daysLeft <= state.data.thresholdDays;

    return { start, duration, end, daysLeft, active, expired, soon };
  }

  function render(){
    // ensure ids + computed end
    state.data.clients = (state.data.clients || []).map(c=>{
      if(!c.id) c.id = uid();
      const start = c.start || isoDate(new Date());
      const duration = safeNum(c.duration, 30);
      const end = c.end || addDays(start, duration);
      return { ...c, start, duration, end };
    });

    // stats
    const total = state.data.clients.length;
    const actives = state.data.clients.filter(c => c.active !== false).length;
    let soon = 0, expired = 0;
    for(const c of state.data.clients){
      const r = computeClientRow(c);
      if(r.expired) expired++;
      if(r.soon && r.active) soon++;
    }

    $("statTotal").textContent = total;
    $("statActive").textContent = actives;
    $("statSoon").textContent = soon;
    $("statExpired").textContent = expired;

    // table
    const tb = $("tbody");
    tb.innerHTML = "";
    if(!total){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" style />, colspan="8" style="color:var(--muted); padding:18px;">Aucun client.</td>`;
      tb.appendChild(tr);
      return;
    }

    // sort by end date ascending
    const clientsSorted = [...state.data.clients].sort((a,b)=>{
      const aa = a.end || "";
      const bb = b.end || "";
      return aa.localeCompare(bb);
    });

    for(const c of clientsSorted){
      const r = computeClientRow(c);

      let pill = `<span class="pill ok"><span class="dot ok"></span>Actif</span>`;
      if(!r.active) pill = `<span class="pill"><span class="dot warn"></span>D√©sactiv√©</span>`;
      else if(r.expired) pill = `<span class="pill bad"><span class="dot bad"></span>Expir√©</span>`;
      else if(r.soon) pill = `<span class="pill warn"><span class="dot warn"></span>Expire bient√¥t</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nameCell">${escapeHtml(c.name || "Client")}</td>
        <td>${escapeHtml(r.start)}</td>
        <td>${escapeHtml(String(r.duration))} j</td>
        <td>${escapeHtml(r.end)}</td>
        <td><b>${r.daysLeft}</b> jour${Math.abs(r.daysLeft)===1?"":"s"}</td>
        <td>${pill}</td>
        <td style="color:var(--muted)">${escapeHtml(c.telegramSentAt || "‚Äî")}</td>
        <td class="tdRight">
          <div class="btnGroup">
            <button class="ghost btnSmall" data-act="renew" data-id="${c.id}">Renew +30</button>
            <button class="ghost btnSmall" data-act="edit" data-id="${c.id}">Edit</button>
            <button class="ghost btnSmall" data-act="toggle" data-id="${c.id}">${r.active ? "Disable" : "Enable"}</button>
            <button class="danger btnSmall" data-act="del" data-id="${c.id}">Delete</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    // persist UI fields
    $("workerBase").value = state.data.workerBase || "";
    $("thresholdDays").value = String(state.data.thresholdDays ?? 2);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Form ----------
  function resetForm(){
    state.editingId = null;
    $("clientName").value = "";
    $("durationDays").value = "30";
    $("btnAddUpdate").textContent = "+ Add Client";
    $("btnCancelEdit").style.display = "none";
  }

  function fillFormForEdit(client){
    state.editingId = client.id;
    $("clientName").value = client.name || "";
    $("startDate").value = client.start || isoDate(new Date());
    $("durationDays").value = String(client.duration || 30);
    $("btnAddUpdate").textContent = "Update Client";
    $("btnCancelEdit").style.display = "inline-block";
  }

  function addOrUpdateClient(){
    const name = $("clientName").value.trim();
    const start = $("startDate").value || isoDate(new Date());
    const duration = safeNum($("durationDays").value, 30);

    if(!name){
      toast("Client name required ‚ùå", "bad");
      return;
    }
    if(duration <= 0){
      toast("Duration must be > 0 ‚ùå", "bad");
      return;
    }

    const end = addDays(start, duration);

    if(state.editingId){
      const idx = state.data.clients.findIndex(x => x.id === state.editingId);
      if(idx >= 0){
        state.data.clients[idx] = {
          ...state.data.clients[idx],
          name, start, duration, end
        };
        toast("Client updated ‚úÖ", "ok");
      }
    }else{
      state.data.clients.push({
        id: uid(),
        name,
        start,
        duration,
        end,
        active: true,
        telegramSentAt: ""
      });
      toast("Client added ‚úÖ", "ok");
    }

    saveLocal();
    render();
    resetForm();
  }

  // ---------- Export/Import ----------
  function exportJSON(){
    const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "abonnements-dashboard.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("Export ready ‚úÖ");
  }

  function importJSONFile(file){
    const r = new FileReader();
    r.onload = () => {
      try{
        const obj = JSON.parse(String(r.result||""));
        if(!obj || typeof obj !== "object") throw new Error("Invalid JSON");
        // accept either full state or only {clients, thresholdDays}
        if(Array.isArray(obj.clients)){
          state.data.clients = obj.clients;
        }
        if(obj.thresholdDays != null) state.data.thresholdDays = safeNum(obj.thresholdDays, 2);
        if(obj.workerBase) state.data.workerBase = String(obj.workerBase);
        // ensure
        saveLocal();
        render();
        toast("Imported ‚úÖ");
      }catch(e){
        toast("Import failed ‚ùå " + e.message, "bad");
      }
    };
    r.readAsText(file);
  }

  function resetAll(){
    if(!confirm("Reset local data? (LocalStorage)")) return;
    state.data.clients = [];
    state.data.thresholdDays = 2;
    // keep workerBase (optional)
    saveLocal();
    render();
    resetForm();
    toast("Reset done ‚úÖ");
  }

  // ---------- Cloud Load/Save ----------
  async function loadFromCloud(){
    $("apiDot").className = "dot warn";
    $("apiStatus").textContent = "Loading cloud...";
    try{
      // ping first (optional)
      await pingWorker();

      const out = await apiFetch("/api/clients", {method:"GET"});
      const data = out && out.data ? out.data : null;

      if(!data || !Array.isArray(data.clients)){
        setApiStatus(false, "Cloud response invalid ‚ùå");
        toast("Cloud response invalid ‚ùå", "bad");
        return;
      }

      // ‚úÖ IMPORTANT: do NOT wipe local if cloud empty
      if(data.clients.length === 0){
        setApiStatus(true, "Cloud is empty ‚Äî keeping local ‚úÖ");
        toast("Cloud empty ‚Äî local kept ‚úÖ", "warn");
        return;
      }

      state.data.thresholdDays = safeNum(data.thresholdDays, state.data.thresholdDays ?? 2);
      state.data.clients = data.clients;

      saveLocal();
      render();
      setApiStatus(true, "Cloud loaded ‚úÖ");
      toast("Cloud loaded ‚úÖ");
    }catch(e){
      setApiStatus(false, "Load cloud failed ‚ùå " + e.message);
      toast("Load cloud failed ‚ùå " + e.message, "bad");
    }
  }

  async function saveToCloud(){
    $("apiDot").className = "dot warn";
    $("apiStatus").textContent = "Saving cloud...";
    try{
      await pingWorker();

      const payload = {
        thresholdDays: safeNum(state.data.thresholdDays, 2),
        clients: state.data.clients
      };
      await apiFetch("/api/clients", {method:"POST", body: payload});

      setApiStatus(true, "Saved to cloud ‚úÖ");
      toast("Saved to cloud ‚úÖ");
    }catch(e){
      setApiStatus(false, "Save cloud failed ‚ùå " + e.message);
      toast("Save cloud failed ‚ùå " + e.message, "bad");
    }
  }

  // ---------- Check & Notify ----------
  async function checkAndNotify(){
    try{
      const threshold = safeNum(state.data.thresholdDays, 2);

      // find expiring
      const expiring = [];
      for(const c of state.data.clients){
        const r = computeClientRow(c);
        if(r.active && r.daysLeft <= threshold && r.daysLeft >= 0){
          expiring.push({ c, r });
        }
      }

      if(!expiring.length){
        toast(`No expiring clients ‚úÖ (‚â§ ${threshold} days)`);
        return;
      }

      const lines = expiring
        .map(x => `‚Ä¢ ${x.c.name} ‚Üí ÿ®ÿßŸÇŸä ${x.r.daysLeft} ŸäŸàŸÖ (ÿßŸÑŸÜŸáÿßŸäÿ©: ${x.r.end})`)
        .join("\n");

      const text = `‚ö†Ô∏è Expiration ŸÇÿ±Ÿäÿ® (‚â§ ${threshold} ÿ£ŸäÿßŸÖ)\n\n${lines}`;

      // call worker notify
      await pingWorker();
      const r = await apiFetch("/api/notify", {method:"POST", body:{message:text}});

      // mark telegramSentAt locally for those clients
      const sentAt = new Date().toISOString().slice(0,19).replace("T"," ");
      for(const x of expiring){
        x.c.telegramSentAt = sentAt;
      }

      saveLocal();
      render();

      toast(r && r.ok ? "Telegram sent ‚úÖ" : "Check response", r && r.ok ? "ok" : "warn");
    }catch(e){
      console.error(e);
      toast("Check & Notify failed ‚ùå " + (e.message || String(e)), "bad");
    }
  }

  // ---------- Events ----------
  function init(){
    // default date
    $("startDate").value = isoDate(new Date());

    // load local state
    loadLocal();

    // ensure defaults
    state.data.thresholdDays = safeNum(state.data.thresholdDays, 2);
    state.data.clients = Array.isArray(state.data.clients) ? state.data.clients : [];
    state.data.workerBase = state.data.workerBase || "";

    // write inputs
    $("workerBase").value = state.data.workerBase || "";
    $("thresholdDays").value = String(state.data.thresholdDays ?? 2);

    // render
    render();

    // ping when base present
    if(state.data.workerBase){
      pingWorker();
    }else{
      setApiStatus(true, "Ready");
    }

    // inputs persist
    $("workerBase").addEventListener("change", ()=>{
      state.data.workerBase = $("workerBase").value.trim();
      saveLocal();
      pingWorker();
    });
    $("thresholdDays").addEventListener("change", ()=>{
      state.data.thresholdDays = safeNum($("thresholdDays").value, 2);
      saveLocal();
      render();
    });

    // buttons
    $("btnAddUpdate").addEventListener("click", addOrUpdateClient);
    $("btnCancelEdit").addEventListener("click", ()=>{
      resetForm();
      toast("Edit canceled");
    });

    $("btnExport").addEventListener("click", exportJSON);
    $("btnImport").addEventListener("click", ()=> $("importFile").click());
    $("importFile").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(file) importJSONFile(file);
      e.target.value = "";
    });
    $("btnReset").addEventListener("click", resetAll);

    $("btnLoadCloud").addEventListener("click", loadFromCloud);
    $("btnSaveCloud").addEventListener("click", saveToCloud);
    $("btnCheckNotify").addEventListener("click", checkAndNotify);

    // table actions
    $("tbody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      const idx = state.data.clients.findIndex(x=>x.id===id);
      if(idx < 0) return;
      const c = state.data.clients[idx];

      if(act === "renew"){
        c.duration = safeNum(c.duration, 30) + 30;
        c.end = addDays(c.start, c.duration);
        saveLocal(); render();
        toast("Renew +30 ‚úÖ");
      }
      if(act === "edit"){
        fillFormForEdit(c);
        toast("Editing‚Ä¶", "warn");
      }
      if(act === "toggle"){
        c.active = !(c.active !== false); // toggle
        saveLocal(); render();
        toast(c.active ? "Enabled ‚úÖ" : "Disabled ‚úÖ", "ok");
      }
      if(act === "del"){
        if(!confirm("Delete this client?")) return;
        state.data.clients.splice(idx,1);
        saveLocal(); render();
        toast("Deleted ‚úÖ");
      }
    });
  }

  init();
</script>
</body>
</html>

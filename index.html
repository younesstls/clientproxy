<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abonnements Dashboard</title>
  <style>
    :root{
      --bg1:#050814; --bg2:#0a1230; --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10); --txt:#eaf0ff; --mut:#a9b7d6;
      --ok:#29d07f; --bad:#ff4d5a; --warn:#ffcc66; --blue:#2f6bff;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(47,107,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(255,77,90,.18), transparent 55%),
        radial-gradient(800px 600px at 40% 90%, rgba(41,208,127,.12), transparent 60%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
      padding:28px 18px 60px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,#2f6bff,#b84dff,#ff4d5a);
      box-shadow:0 12px 30px rgba(47,107,255,.25);
    }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .sub{margin:3px 0 0;color:var(--mut);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button, input{
      font:inherit; color:inherit;
    }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      padding:10px 14px;border-radius:14px; cursor:pointer;
      backdrop-filter: blur(8px);
      transition:.15s;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg, rgba(47,107,255,.85), rgba(47,107,255,.55)); border-color:rgba(47,107,255,.55)}
    .btn.danger{background:rgba(255,77,90,.14); border-color:rgba(255,77,90,.25)}
    .grid4{display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin:14px 0 14px}
    @media (max-width:900px){.grid4{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid4{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .metric .k{color:var(--mut);font-size:13px}
    .metric .v{font-size:28px;font-weight:700;margin-top:4px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    .label{color:var(--mut); font-size:12px; margin-bottom:6px}
    .field{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }
    .field:focus{border-color:rgba(47,107,255,.55)}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .hint{color:var(--mut); font-size:12px; margin-top:6px}
    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:10px}
    th{color:var(--mut); font-size:12px; font-weight:600; text-align:left; padding:0 10px}
    td{
      padding:12px 10px; background:rgba(0,0,0,.18); border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    td:first-child{border-left:1px solid rgba(255,255,255,.08); border-top-left-radius:14px; border-bottom-left-radius:14px}
    td:last-child{border-right:1px solid rgba(255,255,255,.08); border-top-right-radius:14px; border-bottom-right-radius:14px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06)
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .mini{font-size:12px;color:var(--mut)}
    .footer{margin-top:10px;text-align:center;color:var(--mut);font-size:12px}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:9999;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.16);
      color:var(--txt);
      padding:10px 14px; border-radius:999px; backdrop-filter: blur(10px);
      display:none;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      max-width:92vw;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .badge{display:flex; align-items:center; justify-content:flex-end; gap:10px}
    .statusline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .statusline .pill{cursor:default}
    .link{color:#9bb6ff; text-decoration:none}
    .dangerTxt{color: #ff9aa2}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Abonnements Dashboard</h1>
          <div class="sub">Clients • Date fin auto • Jours restants • Notifications Telegram (via Worker)</div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="exportBtn">Export JSON</button>
      <button class="btn" id="importBtn">Import JSON</button>
      <button class="btn danger" id="resetBtn">Reset</button>
      <input type="file" id="fileInp" accept="application/json" hidden />
    </div>
  </div>

  <div class="grid4">
    <div class="card metric"><div class="k">Total</div><div class="v" id="mTotal">0</div></div>
    <div class="card metric"><div class="k">Actifs</div><div class="v" id="mActive">0</div></div>
    <div class="card metric"><div class="k">Expire bientôt</div><div class="v" id="mSoon">0</div></div>
    <div class="card metric"><div class="k">Expirés</div><div class="v" id="mExpired">0</div></div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div class="left" style="min-width:280px">
        <div style="flex:1; min-width:260px">
          <div class="label">Cloudflare Worker (API) — Worker Base URL</div>
          <input class="field" id="workerBase" placeholder="https://...workers.dev" />
          <div class="hint mini">تأكد أن URL كيسالي بـ <b>.workers.dev</b> (بلا /api)</div>
        </div>
        <div style="width:160px">
          <div class="label">Notifier si jours ≤</div>
          <input class="field" id="thresholdDays" type="number" min="0" value="2" />
        </div>
      </div>

      <div class="right">
        <button class="btn" id="loadCloudBtn">Load (Cloud)</button>
        <button class="btn" id="saveCloudBtn">Save (Cloud)</button>
        <button class="btn primary" id="checkNotifyBtn">Check & Notify</button>
      </div>
    </div>

    <div class="statusline" style="margin-top:10px">
      <span class="pill" id="cloudStatus"><span class="dot warn"></span><span id="cloudStatusTxt">Cloud: not checked</span></span>
      <span class="pill" id="localStatus"><span class="dot ok"></span><span id="localStatusTxt">Local: ready</span></span>
      <span class="mini">⚠️ إذا Cloud رجّع فارغ/فشل، الموقع كيحافظ على Local باش مايمسحش clients.</span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="font-weight:700; margin-bottom:10px">Ajouter / Modifier un client</div>

    <div class="row">
      <div>
        <div class="label">Client (nom)</div>
        <input class="field" id="clientName" placeholder="ex: hossa group 200 proxy 1500dh" />
      </div>
      <div style="max-width:220px">
        <div class="label">Début</div>
        <input class="field" id="startDate" type="date" />
      </div>
      <div style="max-width:160px">
        <div class="label">Durée (jours)</div>
        <input class="field" id="durationDays" type="number" min="1" value="30" />
      </div>
      <div style="max-width:180px; display:flex; align-items:flex-end; gap:10px">
        <button class="btn primary" id="addBtn" style="width:100%">+ Add Client</button>
      </div>
    </div>

    <div class="hint">Fin = Début + Durée. Actions: Renew +30 / Edit / Disable / Delete</div>
  </div>

  <div class="card" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Début</th>
          <th>Durée</th>
          <th>Fin</th>
          <th>Jours restants</th>
          <th>Statut</th>
          <th>TelegramSent</th>
          <th style="text-align:right">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">by.bestfriend • KV + Worker • GitHub Pages</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** ================== SETTINGS ================== */
const DEFAULT_WORKER = "https://empty-wood-8ebe.youness-moumine-filali.workers.dev";
const LS_KEY = "abon_dash_v3_state";

const $ = (id) => document.getElementById(id);

const state = {
  data: {
    workerBase: DEFAULT_WORKER,
    thresholdDays: 2,
    clients: []
  },
  editingId: null
};

/** ================== HELPERS ================== */
function uid() {
  return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function isoDate(d) {
  const x = new Date(d);
  if (isNaN(x)) return "";
  return x.toISOString().slice(0,10);
}
function addDays(iso, days) {
  const d = new Date(iso);
  if (isNaN(d)) return "";
  const e = new Date(d.getTime() + Number(days)*86400000);
  return e.toISOString().slice(0,10);
}
function daysLeft(endISO) {
  const now = new Date();
  const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
  const end = new Date(endISO);
  if (isNaN(end)) return null;
  const endDay = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));
  return Math.ceil((endDay - today)/86400000);
}

function toast(msg, ms=2400) {
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", ms);
}

function setCloudStatus(kind, text) {
  const pill = $("cloudStatus");
  const dot = pill.querySelector(".dot");
  dot.className = "dot " + (kind==="ok"?"ok":kind==="bad"?"bad":"warn");
  $("cloudStatusTxt").textContent = text;
}

function normalizeClient(c) {
  const out = { ...c };
  if (!out.id) out.id = uid();
  if (out.active === undefined) out.active = true;

  // compute end if missing
  if (!out.end && out.start && out.duration) {
    out.end = addDays(out.start, out.duration);
  }
  return out;
}

function safeParseJSON(text) {
  try { return JSON.parse(text); } catch { return null; }
}

/** ================== LOCAL STORAGE ================== */
function saveLocal() {
  localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  $("localStatusTxt").textContent = "Local: saved";
  setTimeout(()=> $("localStatusTxt").textContent="Local: ready", 1200);
}
function loadLocal() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;
  const parsed = safeParseJSON(raw);
  if (!parsed) return false;

  state.data.workerBase = parsed.workerBase || DEFAULT_WORKER;
  state.data.thresholdDays = Number(parsed.thresholdDays ?? 2);
  state.data.clients = Array.isArray(parsed.clients) ? parsed.clients.map(normalizeClient) : [];
  return true;
}

/** ================== CLOUD API ================== */
function apiURL(path) {
  const base = (state.data.workerBase || "").trim().replace(/\/+$/,"");
  return base + path;
}

async function apiFetch(path, opts={}) {
  const r = await fetch(apiURL(path), {
    ...opts,
    headers: { "Content-Type":"application/json", ...(opts.headers||{}) }
  });
  const txt = await r.text();
  const j = safeParseJSON(txt);
  if (!r.ok) {
    const msg = (j && (j.error || j.message)) ? (j.error || j.message) : (txt || ("HTTP " + r.status));
    throw new Error(msg);
  }
  return j;
}

async function cloudLoad({ silent=false } = {}) {
  try {
    setCloudStatus("warn", "Cloud: loading...");
    const res = await apiFetch("/api/clients", { method:"GET" });

    const cloudData = res?.data;
    const cloudClients = Array.isArray(cloudData?.clients) ? cloudData.clients : null;

    // IMPORTANT: do not overwrite local with empty unless user explicitly wants
    if (cloudClients && cloudClients.length > 0) {
      state.data.thresholdDays = Number(cloudData.thresholdDays ?? state.data.thresholdDays ?? 2);
      state.data.clients = cloudClients.map(normalizeClient);
      saveLocal();
      render();
      setCloudStatus("ok", "Cloud: loaded ✅");
      if (!silent) toast("Cloud loaded ✅");
      return true;
    }

    // if cloud is empty -> keep local, warn
    setCloudStatus("warn", "Cloud: empty (kept local) ⚠️");
    if (!silent) toast("Cloud empty: kept local ⚠️");
    return false;

  } catch(e) {
    setCloudStatus("bad", "Cloud: load failed ❌");
    if (!silent) toast("Load cloud failed ❌ " + e.message);
    return false;
  }
}

async function cloudSave() {
  try {
    setCloudStatus("warn", "Cloud: saving...");
    const body = {
      thresholdDays: Number(state.data.thresholdDays ?? 2),
      clients: (state.data.clients || []).map(normalizeClient),
    };

    await apiFetch("/api/clients", { method:"POST", body: JSON.stringify(body) });

    setCloudStatus("ok", "Cloud: saved ✅");
    toast("Save cloud OK ✅");
    return true;
  } catch(e) {
    setCloudStatus("bad", "Cloud: save failed ❌");
    toast("Save cloud failed ❌ " + e.message);
    return false;
  }
}

/** ================== TELEGRAM CHECK & NOTIFY ================== */
async function checkAndNotify() {
  try {
    const threshold = Number(state.data.thresholdDays ?? 2);
    const expiring = [];

    for (const c of (state.data.clients||[])) {
      if (!c || c.active === false) continue;
      const endISO = c.end || (c.start && c.duration ? addDays(c.start, c.duration) : "");
      if (!endISO) continue;
      const d = daysLeft(endISO);
      if (d === null) continue;
      if (d <= threshold && d >= 0) expiring.push({ ...c, end: endISO, days: d });
    }

    if (!expiring.length) {
      toast(`No expiring clients ✅ (≤ ${threshold} days)`);
      return;
    }

    const lines = expiring
      .map(x => `• ${x.name} → باقي ${x.days} يوم (النهاية: ${x.end})`)
      .join("\n");

    const text = `⚠️ Expiration قريب (≤ ${threshold} أيام)\n\n${lines}`;

    const r = await apiFetch("/api/notify", {
      method:"POST",
      body: JSON.stringify({ message: text })
    });

    // mark sent time locally
    const sentAt = new Date().toISOString().slice(0,19).replace("T"," ");
    const ids = new Set(expiring.map(x=>x.id));
    state.data.clients = state.data.clients.map(c => ids.has(c.id) ? { ...c, telegramSentAt: sentAt } : c);
    saveLocal();
    render();

    toast("Telegram sent ✅ " + (r.ok ? "OK" : ""));
  } catch(e) {
    console.error(e);
    toast("Check & Notify failed ❌ " + (e.message || String(e)));
  }
}

/** ================== RENDER ================== */
function renderMetrics() {
  const clients = state.data.clients || [];
  const total = clients.length;
  const active = clients.filter(c => c.active !== false).length;

  const threshold = Number(state.data.thresholdDays ?? 2);
  let soon = 0, expired = 0;

  for (const c of clients) {
    const endISO = c.end || (c.start && c.duration ? addDays(c.start, c.duration) : "");
    if (!endISO) continue;
    const d = daysLeft(endISO);
    if (d === null) continue;
    if (d < 0) expired++;
    else if (d <= threshold && c.active !== false) soon++;
  }

  $("mTotal").textContent = total;
  $("mActive").textContent = active;
  $("mSoon").textContent = soon;
  $("mExpired").textContent = expired;
}

function renderTable() {
  const tbody = $("tbody");
  tbody.innerHTML = "";

  const clients = (state.data.clients || []).slice();
  // sort by end date asc
  clients.sort((a,b)=> (a.end||"").localeCompare(b.end||""));

  for (const c of clients) {
    const endISO = c.end || (c.start && c.duration ? addDays(c.start, c.duration) : "");
    const left = endISO ? daysLeft(endISO) : null;

    const tr = document.createElement("tr");

    const statusPill = (() => {
      const active = c.active !== false;
      if (!active) return `<span class="pill"><span class="dot warn"></span>Disabled</span>`;
      if (left === null) return `<span class="pill"><span class="dot warn"></span>Unknown</span>`;
      if (left < 0) return `<span class="pill"><span class="dot bad"></span>Expiré</span>`;
      return `<span class="pill"><span class="dot ok"></span>Actif</span>`;
    })();

    tr.innerHTML = `
      <td><b>${escapeHTML(c.name || "")}</b></td>
      <td>${escapeHTML(c.start || "")}</td>
      <td>${escapeHTML(String(c.duration || ""))}${c.duration ? " j" : ""}</td>
      <td>${escapeHTML(endISO || "")}</td>
      <td>${left === null ? "—" : (left < 0 ? `<span class="dangerTxt">${left} j</span>` : `${left} j`)}</td>
      <td>${statusPill}</td>
      <td>${escapeHTML(c.telegramSentAt || "—")}</td>
      <td style="text-align:right">
        <button class="btn" data-act="renew" data-id="${c.id}">Renew +30</button>
        <button class="btn" data-act="edit" data-id="${c.id}">Edit</button>
        <button class="btn" data-act="toggle" data-id="${c.id}">${c.active === false ? "Enable" : "Disable"}</button>
        <button class="btn danger" data-act="del" data-id="${c.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      handleRowAction(act, id);
    });
  });
}

function render() {
  renderMetrics();
  renderTable();
}

/** ================== ACTIONS ================== */
function escapeHTML(s) {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function resetForm() {
  state.editingId = null;
  $("clientName").value = "";
  $("durationDays").value = 30;
  $("startDate").value = isoDate(new Date());
  $("addBtn").textContent = "+ Add Client";
}

function upsertClient() {
  const name = $("clientName").value.trim();
  const start = $("startDate").value;
  const duration = Number($("durationDays").value || 30);

  if (!name) return toast("Client name required ❌");
  if (!start) return toast("Start date required ❌");
  if (!duration || duration < 1) return toast("Duration must be >= 1 ❌");

  const end = addDays(start, duration);

  if (state.editingId) {
    state.data.clients = state.data.clients.map(c => {
      if (c.id !== state.editingId) return c;
      return normalizeClient({ ...c, name, start, duration, end });
    });
    toast("Client updated ✅");
  } else {
    state.data.clients.push(normalizeClient({ id: uid(), name, start, duration, end, active:true }));
    toast("Client added ✅");
  }
  saveLocal();
  render();
  resetForm();
}

function handleRowAction(act, id) {
  const idx = (state.data.clients || []).findIndex(c => c.id === id);
  if (idx < 0) return;

  const c = state.data.clients[idx];

  if (act === "del") {
    state.data.clients.splice(idx,1);
    saveLocal();
    render();
    toast("Deleted ✅");
    return;
  }

  if (act === "toggle") {
    c.active = !(c.active !== false); // toggle
    state.data.clients[idx] = normalizeClient(c);
    saveLocal();
    render();
    toast(c.active ? "Enabled ✅" : "Disabled ⚠️");
    return;
  }

  if (act === "renew") {
    // renew from end if exists else compute
    const endISO = c.end || (c.start && c.duration ? addDays(c.start, c.duration) : "");
    let base = endISO || isoDate(new Date());
    const newStart = base; // keep start as current end date
    const newDuration = Number(c.duration || 30) + 30;
    const newEnd = addDays(c.start || isoDate(new Date()), newDuration);

    c.duration = newDuration;
    c.end = newEnd;
    state.data.clients[idx] = normalizeClient(c);
    saveLocal();
    render();
    toast("Renew +30 ✅");
    return;
  }

  if (act === "edit") {
    state.editingId = c.id;
    $("clientName").value = c.name || "";
    $("startDate").value = c.start || isoDate(new Date());
    $("durationDays").value = Number(c.duration || 30);
    $("addBtn").textContent = "Save Edit";
    toast("Editing… ✏️");
    return;
  }
}

/** ================== IMPORT/EXPORT ================== */
function exportJSON() {
  const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "abon_dashboard_export.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSONFile(file) {
  const fr = new FileReader();
  fr.onload = () => {
    const parsed = safeParseJSON(fr.result);
    if (!parsed) return toast("Invalid JSON ❌");

    // merge safely
    state.data.workerBase = parsed.workerBase || state.data.workerBase || DEFAULT_WORKER;
    state.data.thresholdDays = Number(parsed.thresholdDays ?? state.data.thresholdDays ?? 2);
    state.data.clients = Array.isArray(parsed.clients) ? parsed.clients.map(normalizeClient) : state.data.clients;

    saveLocal();
    render();
    toast("Imported ✅");
  };
  fr.readAsText(file);
}

/** ================== INIT ================== */
(function init(){
  // default date = today
  $("startDate").value = isoDate(new Date());

  // load local first
  const hasLocal = loadLocal();

  // set inputs from state
  $("workerBase").value = state.data.workerBase || DEFAULT_WORKER;
  $("thresholdDays").value = Number(state.data.thresholdDays ?? 2);

  // ensure ids
  state.data.clients = (state.data.clients || []).map(normalizeClient);
  saveLocal();
  render();

  // persist input changes
  $("workerBase").addEventListener("change", ()=>{
    state.data.workerBase = $("workerBase").value.trim().replace(/\/+$/,"");
    saveLocal();
  });
  $("thresholdDays").addEventListener("change", ()=>{
    state.data.thresholdDays = Number($("thresholdDays").value || 2);
    saveLocal();
    render();
  });

  // buttons
  $("addBtn").addEventListener("click", upsertClient);
  $("exportBtn").addEventListener("click", exportJSON);
  $("importBtn").addEventListener("click", ()=> $("fileInp").click());
  $("fileInp").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if (f) importJSONFile(f);
    e.target.value = "";
  });
  $("resetBtn").addEventListener("click", ()=>{
    if (!confirm("Reset local data?")) return;
    localStorage.removeItem(LS_KEY);
    state.data = { workerBase: DEFAULT_WORKER, thresholdDays: 2, clients: [] };
    $("workerBase").value = DEFAULT_WORKER;
    $("thresholdDays").value = 2;
    resetForm();
    saveLocal();
    render();
    toast("Reset ✅");
  });

  $("loadCloudBtn").addEventListener("click", ()=> cloudLoad({ silent:false }));
  $("saveCloudBtn").addEventListener("click", ()=> cloudSave());
  $("checkNotifyBtn").addEventListener("click", ()=> checkAndNotify());

  // Auto load cloud on start (important for phone/pc sync)
  // only if cloud has data; if empty, keep local
  cloudLoad({ silent:true });

  // status initial
  setCloudStatus("warn", hasLocal ? "Cloud: ready (auto-load…)" : "Cloud: auto-load…");
  resetForm();
})();
</script>
</body>
</html>
